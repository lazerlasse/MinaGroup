@page "{userId?}/{evaluationDate?}"
@model MinaGroup.Backend.Pages.SelfEvaluations.CreateModel

@{
    // Hvis der kommer parametre med, viser vi "Udfyld evaluering" - ellers "Opret Selvevalueringsskema"
    var hasRouteParams = !string.IsNullOrEmpty(Model.RouteUserId) && Model.RouteEvaluationDate.HasValue;
    ViewData["Title"] = hasRouteParams ? "Udfyld evaluering" : "Opret Selvevalueringsskema";
}

<h1 class="text-center display-4 fw-bold text-primary mb-4">@ViewData["Title"]</h1>

<hr />

<div class="row justify-content-center">
    <div class="col-md-8">
        <form method="post" class="p-4 border rounded shadow-sm bg-light">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- Hidden binding (kun hvis vi kommer via route med låst bruger/dato) -->
            @if (!string.IsNullOrEmpty(Model.RouteUserId))
            {
                <input type="hidden" asp-for="SelfEvaluation.UserId" />
                <input type="hidden" asp-for="SelfEvaluation.EvaluationDate" />
            }

            <!-- Evaluation dato -->
            <div class="mb-3">
                <label asp-for="SelfEvaluation.EvaluationDate" class="form-label fw-bold"></label>
                @if (Model.RouteEvaluationDate.HasValue)
                {
                    <input value="@Model.RouteEvaluationDate.Value.ToString("dd.MM.yyyy")" class="form-control" readonly />
                }
                else
                {
                    <input asp-for="SelfEvaluation.EvaluationDate" class="form-control" type="date" />
                    <span asp-validation-for="SelfEvaluation.EvaluationDate" class="text-danger"></span>
                }
            </div>

            <!-- CPR felt -->
            <div class="mb-3">
                <label class="form-label fw-bold">CPR-nummer</label>
                @if (!string.IsNullOrEmpty(Model.RouteUserId) && !string.IsNullOrEmpty(Model.UserCPRNumber))
                {
                    <!-- Kommer via route: vis CPR for den låste bruger (allerede maskeret) -->
                    <input value="@Model.UserCPRNumber" class="form-control" readonly />
                }
                else
                {
                    <!-- Ingen route-bruger: vis dynamisk CPR for valgt borger -->
                    <input id="SelectedUserCpr" class="form-control" type="text" readonly />
                }
            </div>

            <!-- Borger: hvis route param er sat vis readonly navn, ellers dropdown -->
            <div class="mb-3">
                <label class="form-label fw-bold">Borger</label>
                @if (!string.IsNullOrEmpty(Model.RouteUserId) && !string.IsNullOrEmpty(Model.UserFullName))
                {
                    <input value="@Model.UserFullName" class="form-control" readonly />
                }
                else
                {
                    <select asp-for="SelfEvaluation.UserId"
                            class="form-select"
                            id="UserSelect">
                        <option value="">-- Vælg borger --</option>
                        @if (Model.BorgerUsers != null)
                        {
                            foreach (var u in Model.BorgerUsers)
                            {
                                <option value="@u.Id" data-cpr="@u.MaskedCPR">
                                    @u.FullName (@u.MaskedCPR)
                                </option>
                            }
                        }
                    </select>
                    <span asp-validation-for="SelfEvaluation.UserId" class="text-danger"></span>
                }
            </div>

            <!-- Sygdom -->
            <div class="mb-3">
                <label asp-for="SelfEvaluation.IsSick" class="form-label fw-bold"></label>
                <div>
                    <input class="form-check-input me-2" asp-for="SelfEvaluation.IsSick" id="SelfEvaluation_IsSick" />
                    <span asp-validation-for="SelfEvaluation.IsSick" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3" id="sickReasonSection">
                <label asp-for="SelfEvaluation.SickReason" class="form-label fw-bold"></label>
                <textarea asp-for="SelfEvaluation.SickReason" class="form-control"></textarea>
                <span asp-validation-for="SelfEvaluation.SickReason" class="text-danger"></span>
            </div>

            <!-- Udeblevet -->
            <div class="mb-3">
                <label asp-for="SelfEvaluation.IsNoShow" class="form-label fw-bold"></label>
                <div>
                    <input class="form-check-input me-2" asp-for="SelfEvaluation.IsNoShow" id="SelfEvaluation_IsNoShow" />
                    <span asp-validation-for="SelfEvaluation.IsNoShow" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3" id="noShowReasonSection">
                <label asp-for="SelfEvaluation.NoShowReason" class="form-label fw-bold"></label>
                <textarea asp-for="SelfEvaluation.NoShowReason" class="form-control"></textarea>
                <span asp-validation-for="SelfEvaluation.NoShowReason" class="text-danger"></span>
            </div>

            <!-- Fri og lovligt fravær -->
            <div class="mb-3">
                <label asp-for="SelfEvaluation.IsOffWork" class="form-label fw-bold"></label>
                <div>
                    <input class="form-check-input me-2" asp-for="SelfEvaluation.IsOffWork" id="SelfEvaluation_IsOffWork" />
                    <span asp-validation-for="SelfEvaluation.IsOffWork" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3" id="offWorkReasonSection">
                <label asp-for="SelfEvaluation.OffWorkReason" class="form-label fw-bold"></label>
                <textarea asp-for="SelfEvaluation.OffWorkReason" class="form-control"></textarea>
                <span asp-validation-for="SelfEvaluation.OffWorkReason" class="text-danger"></span>
            </div>

            <!-- alt andet indhold pakkes i denne sektion og skjules når IsSick===true via JS -->
            <div id="showFormSection">
                <div class="mb-3">
                    <label asp-for="SelfEvaluation.ArrivalTime" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.ArrivalTime" type="time" class="form-control" id="SelfEvaluation_ArrivalTime" />
                    <span asp-validation-for="SelfEvaluation.ArrivalTime" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.DepartureTime" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.DepartureTime" type="time" class="form-control" id="SelfEvaluation_DepartureTime" />
                    <span asp-validation-for="SelfEvaluation.DepartureTime" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.TotalHours" class="form-label fw-bold"></label>
                    <!-- Visning -->
                    <input id="totalHoursDisplay" class="form-control disabled" type="text" readonly />
                    <!-- Hidden, faktisk value der postes (format HH:mm:ss) -->
                    <input type="hidden" asp-for="SelfEvaluation.TotalHours" id="SelfEvaluation_TotalHours" />
                    <span asp-validation-for="SelfEvaluation.TotalHours" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.HadBreak" class="form-label fw-bold"></label>
                    <div>
                        <input class="form-check-input me-2" asp-for="SelfEvaluation.HadBreak" id="SelfEvaluation_HadBreak" />
                        <span asp-validation-for="SelfEvaluation.HadBreak" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3" id="breakDurationSection">
                    <label asp-for="SelfEvaluation.BreakDuration" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.BreakDuration" type="time" class="form-control" id="SelfEvaluation_BreakDuration" />
                    <span asp-validation-for="SelfEvaluation.BreakDuration" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.ArrivalStatus" class="form-label fw-bold"></label>
                    <select asp-for="SelfEvaluation.ArrivalStatus" class="form-select"
                            asp-items="@(new SelectList(Model.ArrivalOptions, Model.SelfEvaluation?.ArrivalStatus))"></select>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.Collaboration" class="form-label fw-bold"></label>
                    <select asp-for="SelfEvaluation.Collaboration" class="form-select"
                            asp-items="@(new SelectList(Model.CollaborationOptions, Model.SelfEvaluation?.Collaboration))"></select>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.Assistance" class="form-label fw-bold"></label>
                    <select asp-for="SelfEvaluation.Assistance" class="form-select"
                            asp-items="@(new SelectList(Model.AssistanceOptions, Model.SelfEvaluation?.Assistance))"></select>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.Aid" class="form-label fw-bold"></label>
                    <select asp-for="SelfEvaluation.Aid" class="form-select" id="SelfEvaluation_Aid">
                        @foreach (var option in Model.AidOptions)
                        {
                            <option value="@option" selected="@(option == Model.SelfEvaluation?.Aid ? "selected" : null)">@option</option>
                        }
                    </select>
                </div>

                <div class="mb-3" id="aidDescriptionSection" style="display:none">
                    <label asp-for="SelfEvaluation.AidDescription" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.AidDescription" class="form-control" id="SelfEvaluation_AidDescription" />
                    <span asp-validation-for="SelfEvaluation.AidDescription" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.HadDiscomfort" class="form-label fw-bold"></label>
                    <div>
                        <input class="form-check-input me-2" asp-for="SelfEvaluation.HadDiscomfort" id="SelfEvaluation_HadDiscomfort" />
                        <span asp-validation-for="SelfEvaluation.HadDiscomfort" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3" id="discomfortDescriptionSection">
                    <label asp-for="SelfEvaluation.DiscomfortDescription" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.DiscomfortDescription" class="form-control" />
                    <span asp-validation-for="SelfEvaluation.DiscomfortDescription" class="text-danger"></span>
                </div>

                @* Dagens arbejdsopgaver *@
                @if (Model.TaskOptions?.Any() == true)
                {
                    <div class="mb-3">
                        <label asp-for="SelfEvaluation.SelectedTask" class="form-label fw-bold"></label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var t in Model.TaskOptions)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="SelectedTaskIds" value="@t.TaskOptionId" />
                                    <label class="form-check-label">@t.TaskName</label>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.CommentFromUser" class="form-label fw-bold"></label>
                    <textarea asp-for="SelfEvaluation.CommentFromUser" class="form-control"></textarea>
                    <span asp-validation-for="SelfEvaluation.CommentFromUser" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.NextMeetingNotes" class="form-label fw-bold"></label>
                    <input asp-for="SelfEvaluation.NextMeetingNotes" class="form-control" />
                    <span asp-validation-for="SelfEvaluation.NextMeetingNotes" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="SelfEvaluation.CommentFromUser" class="form-label fw-bold"></label>
                    <textarea asp-for="SelfEvaluation.CommentFromUser" class="form-control"></textarea>
                    <span asp-validation-for="SelfEvaluation.CommentFromUser" class="text-danger"></span>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a class="btn btn-outline-secondary" asp-page="./Index">Fortryd</a>
                <button type="submit" class="btn btn-outline-primary">Opret / Gem</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <!-- JS som styrer vis/skjul og beregner TotalHours (samme fil som tidligere) -->
    <script src="~/js/selfevaluation-form.js"></script>
    <script src="~/js/cpr-sync.js"></script>
}