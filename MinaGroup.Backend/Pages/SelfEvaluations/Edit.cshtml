@page "{id:int}"
@model MinaGroup.Backend.Pages.SelfEvaluations.EditModel
@{
    ViewData["Title"] = "Rediger selvevaluering";
    Layout = "/Pages/Shared/_Layout.cshtml";
}

<h1 class="text-center display-4 fw-bold text-primary mb-4">@ViewData["Title"]</h1>

<hr />

<div class="row justify-content-center">
    <div class="col-md-8">
        <form method="post" class="p-4 border rounded shadow-sm bg-light">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <input type="hidden" asp-for="Evaluation.Id" />
            <input type="hidden" asp-for="Evaluation.UserId" />

            <!-- Dato -->
            <div class="mb-3">
                <label asp-for="Evaluation.EvaluationDate" class="form-label fw-bold"></label>
                <input value="@Model.Evaluation.EvaluationDate.ToShortDateString()" disabled class="form-control" />
            </div>

            <!-- CPR -->
            <div class="mb-3">
                <label class="form-label fw-bold">CPR-nummer</label>
                <input value="@Model.MaskedCpr" class="form-control" readonly />
            </div>

            <!-- Borger -->
            <div class="mb-3">
                <label asp-for="Evaluation.User" class="form-label fw-bold"></label>
                <input value="@Model.Evaluation.User.FullName" class="form-control" readonly />
            </div>

            <!-- IsSick -->
            <div class="mb-3 form-check">
                <label class="form-check-label fw-bold" asp-for="Evaluation.IsSick"></label>
                <input asp-for="Evaluation.IsSick" type="checkbox" class="form-check-input" id="SelfEvaluation_IsSick" />
                <span asp-validation-for="Evaluation.IsSick" class="text-danger"></span>
            </div>

            <div class="mb-3" id="sickReasonSection" style="display:none;">
                <label class="form-label fw-bold" asp-for="Evaluation.SickReason"></label>
                <input asp-for="Evaluation.SickReason" class="form-control" />
                <span asp-validation-for="Evaluation.SickReason" class="text-danger"></span>
            </div>

            <!-- IsNoShow -->
            <div class="mb-3 form-check">
                <label class="form-check-label fw-bold" asp-for="Evaluation.IsNoShow"></label>
                <input class="form-check-input me-2" type="checkbox" asp-for="Evaluation.IsNoShow" id="SelfEvaluation_IsNoShow" />
                <span asp-validation-for="Evaluation.IsNoShow" class="text-danger"></span>
            </div>

            <div class="mb-3" id="noShowReasonSection" style="display:none;">
                <label class="form-label fw-bold" asp-for="Evaluation.NoShowReason"></label>
                <input asp-for="Evaluation.NoShowReason" class="form-control" />
                <span asp-validation-for="Evaluation.NoShowReason" class="text-danger"></span>
            </div>

            <!-- IsOffWork -->
            <div class="mb-3 form-check">
                <label class="form-check-label fw-bold" asp-for="Evaluation.IsOffWork"></label>
                <input class="form-check-input me-2" type="checkbox" asp-for="Evaluation.IsOffWork" id="SelfEvaluation_IsOffWork" />
                <span asp-validation-for="Evaluation.IsOffWork" class="text-danger"></span>
            </div>

            <div class="mb-3" id="offWorkReasonSection" style="display:none;">
                <label class="form-label fw-bold" asp-for="Evaluation.OffWorkReason"></label>
                <input asp-for="Evaluation.OffWorkReason" class="form-control" />
                <span asp-validation-for="Evaluation.OffWorkReason" class="text-danger"></span>
            </div>

            <div id="showFormSection">
                <!-- ArrivalTime -->
                <div class="mb-3">
                    <label asp-for="Evaluation.ArrivalTime" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.ArrivalTime" type="time" class="form-control" id="SelfEvaluation_ArrivalTime" />
                    <span asp-validation-for="Evaluation.ArrivalTime" class="text-danger"></span>
                </div>

                <!-- DepartureTime -->
                <div class="mb-3">
                    <label asp-for="Evaluation.DepartureTime" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.DepartureTime" type="time" class="form-control" id="SelfEvaluation_DepartureTime" />
                    <span asp-validation-for="Evaluation.DepartureTime" class="text-danger"></span>
                </div>

                <!-- TotalHours -->
                <div class="mb-3">
                    <label asp-for="Evaluation.TotalHours" class="form-label fw-bold"></label>
                    <input id="totalHoursDisplay" class="form-control" type="text" readonly />
                    <input type="hidden" asp-for="Evaluation.TotalHours" id="SelfEvaluation_TotalHours" />
                    <span asp-validation-for="Evaluation.TotalHours" class="text-danger"></span>
                </div>

                <!-- HadBreak -->
                <div class="mb-3 form-check">
                    <label class="form-check-label fw-bold" asp-for="Evaluation.HadBreak"></label>
                    <input asp-for="Evaluation.HadBreak" type="checkbox" class="form-check-input" id="SelfEvaluation_HadBreak" />
                    <span asp-validation-for="Evaluation.HadBreak" class="text-danger"></span>
                </div>

                <!-- BreakDuration -->
                <div class="mb-3" id="breakDurationSection">
                    <label asp-for="Evaluation.BreakDuration" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.BreakDuration" type="time" class="form-control" id="SelfEvaluation_BreakDuration" />
                    <span asp-validation-for="Evaluation.BreakDuration" class="text-danger"></span>
                </div>

                <!-- ArrivalStatus -->
                <div class="mb-3">
                    <label asp-for="Evaluation.ArrivalStatus" class="form-label fw-bold"></label>
                    <select asp-for="Evaluation.ArrivalStatus" class="form-select">
                        @foreach (var option in Model.ArrivalOptions)
                        {
                            <option value="@option" selected="@(option == Model.Evaluation.ArrivalStatus ? "selected" : null)">
                                @option
                            </option>
                        }
                    </select>
                </div>

                <!-- Collaboration -->
                <div class="mb-3">
                    <label asp-for="Evaluation.Collaboration" class="form-label fw-bold"></label>
                    <select asp-for="Evaluation.Collaboration" class="form-select">
                        @foreach (var option in Model.CollaborationOptions)
                        {
                            <option value="@option" selected="@(option == Model.Evaluation.Collaboration ? "selected" : null)">
                                @option
                            </option>
                        }
                    </select>
                </div>

                <!-- Assistance -->
                <div class="mb-3">
                    <label asp-for="Evaluation.Assistance" class="form-label fw-bold"></label>
                    <select asp-for="Evaluation.Assistance" class="form-select">
                        @foreach (var option in Model.AssistanceOptions)
                        {
                            <option value="@option" selected="@(option == Model.Evaluation.Assistance ? "selected" : null)">
                                @option
                            </option>
                        }
                    </select>
                </div>

                <!-- Aid -->
                <div class="mb-3">
                    <label asp-for="Evaluation.Aid" class="form-label fw-bold"></label>
                    <select asp-for="Evaluation.Aid" class="form-select" id="SelfEvaluation_Aid">
                        @foreach (var option in Model.AidOptions)
                        {
                            <option value="@option" selected="@(option == Model.Evaluation.Aid ? "selected" : null)">
                                @option
                            </option>
                        }
                    </select>
                </div>

                <!-- AidDescription -->
                <div class="mb-3" id="aidDescriptionSection" style="display:none;">
                    <label asp-for="Evaluation.AidDescription" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.AidDescription" class="form-control" id="SelfEvaluation_AidDescription" />
                    <span asp-validation-for="Evaluation.AidDescription" class="text-danger"></span>
                </div>

                <!-- HadDiscomfort -->
                <div class="mb-3 form-check">
                    <label class="form-check-label fw-bold" asp-for="Evaluation.HadDiscomfort"></label>
                    <input asp-for="Evaluation.HadDiscomfort" type="checkbox" class="form-check-input" id="SelfEvaluation_HadDiscomfort" />
                    <span asp-validation-for="Evaluation.HadDiscomfort" class="text-danger"></span>
                </div>

                <!-- DiscomfortDescription -->
                <div class="mb-3" id="discomfortDescriptionSection">
                    <label asp-for="Evaluation.DiscomfortDescription" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.DiscomfortDescription" class="form-control" />
                    <span asp-validation-for="Evaluation.DiscomfortDescription" class="text-danger"></span>
                </div>

                <!-- Dagens arbejdsopgaver -->
                @if (Model.TaskOptions?.Any() == true)
                {
                    <div class="mb-3">
                        <label asp-for="Evaluation.SelectedTask" class="form-label fw-bold"></label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var t in Model.TaskOptions)
                            {
                                var isChecked = Model.SelectedTaskIds.Contains(t.TaskOptionId);
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           name="SelectedTaskIds"
                                           value="@t.TaskOptionId"
                                           @(isChecked ? "checked" : null) />
                                    <label class="form-check-label">@t.TaskName</label>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- CommentFromUser -->
                <div class="mb-3">
                    <label asp-for="Evaluation.CommentFromUser" class="form-label fw-bold"></label>
                    <textarea asp-for="Evaluation.CommentFromUser" class="form-control" readonly></textarea>
                    <span asp-validation-for="Evaluation.CommentFromUser" class="text-danger"></span>
                </div>

                <!-- NextMeetingNotes -->
                <div class="mb-3">
                    <label asp-for="Evaluation.NextMeetingNotes" class="form-label fw-bold"></label>
                    <input asp-for="Evaluation.NextMeetingNotes" class="form-control" />
                    <span asp-validation-for="Evaluation.NextMeetingNotes" class="text-danger"></span>
                </div>

                <!-- CommentFromLeader -->
                <div class="mb-3">
                    <label asp-for="Evaluation.CommentFromLeader" class="form-label fw-bold"></label>
                    <textarea asp-for="Evaluation.CommentFromLeader" class="form-control"></textarea>
                    <span asp-validation-for="Evaluation.CommentFromLeader" class="text-danger"></span>
                </div>
            </div>

            <!-- Dato stempler og godkendt sektion -->
            <div class="mb-3">
                <label asp-for="Evaluation.LastUpdated" class="form-label fw-bold"></label>
                <input value="@Model.Evaluation.LastUpdated.ToString("dd.MM.yyyy HH:mm")" disabled class="form-control" />
            </div>

            <div class="mb-3">
                <label asp-for="Evaluation.ApprovedByUser" class="form-label fw-bold"></label>
                <input value="@Model.Evaluation.ApprovedByUser?.FullName" disabled class="form-control" />
            </div>

            <div class="d-flex justify-content-between">
                <a asp-page="./Index" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Fortryd
                </a>
                <button type="submit" class="btn btn-primary fw-bold">
                    <i class="bi bi-save"></i> Gem ændringer
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial");

    <!-- JS som styrer vis/skjul og beregner TotalHours (samme fil som tidligere) -->
    <script src="~/js/selfevaluation-form.js"></script>
}